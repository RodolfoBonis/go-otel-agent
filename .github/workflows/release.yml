name: Release

on:
  # Auto-release when PR with release label is merged
  pull_request:
    types: [closed]
    branches: [main]

  # Keep manual tag push as fallback
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  # Determine version bump from PR labels
  resolve-version:
    name: Resolve Version
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'push') ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.merged == true &&
       (contains(github.event.pull_request.labels.*.name, 'release:patch') ||
        contains(github.event.pull_request.labels.*.name, 'release:minor') ||
        contains(github.event.pull_request.labels.*.name, 'release:major')))
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      bump: ${{ steps.version.outputs.bump }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "tag=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
            echo "bump=manual" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Get latest tag
          LATEST=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.' | head -1)
          if [[ -z "$LATEST" ]]; then
            LATEST="v0.0.0"
          fi

          # Parse version
          MAJOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f1)
          MINOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f2)
          PATCH=$(echo "$LATEST" | sed 's/v//' | cut -d. -f3)

          # Determine bump type from PR labels
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'

          if echo "$LABELS" | grep -q "release:major"; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            BUMP="major"
          elif echo "$LABELS" | grep -q "release:minor"; then
            MINOR=$((MINOR + 1))
            PATCH=0
            BUMP="minor"
          else
            PATCH=$((PATCH + 1))
            BUMP="patch"
          fi

          TAG="v${MAJOR}.${MINOR}.${PATCH}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "bump=$BUMP" >> "$GITHUB_OUTPUT"
          echo "Resolved: $LATEST -> $TAG ($BUMP)"

  test:
    name: Verify Tests
    runs-on: ubuntu-latest
    needs: resolve-version
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-1.24-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-1.24-

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -race ./...

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [resolve-version, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Create and push tag
        if: github.event_name == 'pull_request'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ needs.resolve-version.outputs.tag }}
          git push origin ${{ needs.resolve-version.outputs.tag }}

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.resolve-version.outputs.tag }}"
          BUMP="${{ needs.resolve-version.outputs.bump }}"

          gh release create "$TAG" \
            --title "$TAG" \
            --generate-notes \
            --latest

      - name: Trigger Go module proxy update
        run: |
          GOPROXY=https://proxy.golang.org GO111MODULE=on \
            go list -m github.com/${{ github.repository }}@${{ needs.resolve-version.outputs.tag }}
